<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>TooN: Speed, but not at the expense of accuracy.</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">TooN&#160;<span id="projectnumber">2.0.0-beta8</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">Speed, but not at the expense of accuracy. </div>  </div>
</div>
<div class="contents">
<div class="textblock"><p><a class="el" href="namespaceTooN.html" title="Everything lives inside this namespace.">TooN</a> aims to be a fast library, and may choose between one of several algorithms depending on the size of the arguments.</p>
<p>However <a class="el" href="namespaceTooN.html" title="Everything lives inside this namespace.">TooN</a> will never substitute a fast but numerically inferior algorithm. For example LU decomposition, Gaussian elimination and Gauss-Jordan reduction all have similar numerical properties for computing a matrix inverse. Direct inversino using Cramer's rule is significantly less stable, even for 3x3 matrices.</p>
<p>The following code computes a matrix inverse of the ill conditioned matrix: </p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ \begin{bmatrix} 1 &amp; 2 &amp; 3 \\ 1 &amp; 2 + \epsilon &amp; 3 \\ 1 &amp; 2 &amp; 3 + \epsilon \end{bmatrix}, \]" src="form_126.png"/>
</p>
<p> using LU decomposition, Gauss-Jordan, pseudo-inverse with singular value decomposition and with Cramer's rule. The error is computed as: </p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ \|A^{-1} A - I\|_{\text{fro}} \]" src="form_127.png"/>
</p>
<p> The code is:</p>
<div class="fragment"><pre class="fragment"><span class="preprocessor">#include &lt;TooN/TooN.h&gt;</span>
<span class="preprocessor">#include &lt;TooN/helpers.h&gt;</span>
<span class="preprocessor">#include &lt;TooN/LU.h&gt;</span>
<span class="preprocessor">#include &lt;TooN/GR_SVD.h&gt;</span>
<span class="preprocessor">#include &lt;TooN/gauss_jordan.h&gt;</span>
<span class="preprocessor">#include &lt;TooN/gaussian_elimination.h&gt;</span>
<span class="preprocessor">#include &lt;iomanip&gt;</span>
<span class="keyword">using namespace </span>TooN;
<span class="keyword">using namespace </span>std;
<a class="code" href="structTooN_1_1Matrix.html" title="A matrix.">Matrix&lt;3&gt;</a> invert_cramer(<span class="keyword">const</span> <a class="code" href="structTooN_1_1Matrix.html" title="A matrix.">Matrix&lt;3&gt;</a>&amp; A)
{
    <a class="code" href="structTooN_1_1Matrix.html" title="A matrix.">Matrix&lt;3&gt;</a> i;
    <span class="keywordtype">double</span> t0 = A[0][0]*A[1][1]*A[2][2]-A[0][0]*A[1][2]*A[2][1]-A[1][0]*A[0][1]*A[2][2]+A[1][0]*A[0][2]*A[2][1]+A[2][0]*A[0][1]*A[1][2]-A[2][0]*A[0][2]*A[1][1];
    <span class="keywordtype">double</span> idet = 1/t0;
    t0 = A[1][1]*A[2][2]-A[1][2]*A[2][1];
    i[0][0] = t0*idet;
    t0 = -A[0][1]*A[2][2]+A[0][2]*A[2][1];
    i[0][1] = t0*idet;
    t0 = A[0][1]*A[1][2]-A[0][2]*A[1][1];
    i[0][2] = t0*idet;
    t0 = -A[1][0]*A[2][2]+A[1][2]*A[2][0];
    i[1][0] = t0*idet;
    t0 = A[0][0]*A[2][2]-A[0][2]*A[2][0];
    i[1][1] = t0*idet;
    t0 = -A[0][0]*A[1][2]+A[0][2]*A[1][0];
    i[1][2] = t0*idet;
    t0 = A[1][0]*A[2][1]-A[1][1]*A[2][0];
    i[2][0] = t0*idet;
    t0 = -A[0][0]*A[2][1]+A[0][1]*A[2][0];
    i[2][1] = t0*idet;
    t0 = A[0][0]*A[1][1]-A[0][1]*A[1][0];
    i[2][2] = t0*idet;

    <span class="keywordflow">return</span> i;
}


<span class="keywordtype">int</span> main()
{
    <a class="code" href="structTooN_1_1Matrix.html" title="A matrix.">Matrix&lt;3&gt;</a> singular = <a class="code" href="group__gLinAlg.html#ga970349714fee11f7806fa87d1872b211" title="Package up the function arguments as some data for filling matrices.">Data</a>(1, 2, 3,
                              1, 2, 3,
                              1, 2, 3);
    
    
    <span class="keywordflow">for</span>(<span class="keywordtype">double</span> i=0; i &lt; 1000; i++)
    {
        <span class="keywordtype">double</span> delta = pow(0.9, i); 
        
        <span class="comment">//Make a poorly conditioned matrix</span>
        <a class="code" href="structTooN_1_1Matrix.html" title="A matrix.">Matrix&lt;3&gt;</a> bad = singular;
        bad[2][2] += delta;
        bad[1][1] += delta;

        
        <span class="comment">//Compute the inverse with LU decomposition</span>
        <a class="code" href="structTooN_1_1Matrix.html" title="A matrix.">Matrix&lt;3&gt;</a> linv;
        <a class="code" href="classTooN_1_1LU.html" title="Performs LU decomposition and back substitutes to solve equations.">LU&lt;3&gt;</a> blu(bad);
        linv = blu.get_inverse();

        <span class="comment">//Compute the inverse with Gauss-Jordan reduction</span>
        <a class="code" href="structTooN_1_1Matrix.html" title="A matrix.">Matrix&lt;3, 6&gt;</a> gj;
        <a class="code" href="structTooN_1_1Matrix.html" title="A matrix.">Matrix&lt;3&gt;</a> ginv;
        gj.<a class="code" href="structTooN_1_1Matrix.html#a53b254fb71baceda82834745cef2c60b" title="Extract a sub-matrix.">slice</a>&lt;0,0,3,3&gt;() = bad;
        gj.<a class="code" href="structTooN_1_1Matrix.html#a53b254fb71baceda82834745cef2c60b" title="Extract a sub-matrix.">slice</a>&lt;0,3,3,3&gt;() = <a class="code" href="group__gLinAlg.html#ga738fa6ab6e1ba68370aaa9380fde620c" title="This function is used to add a scalar to the diagonal of a matrix, or to construct matrices...">Identity</a>;
        <a class="code" href="group__gDecomps.html#ga8af8145ff9e22a712a97ac4b717bed53" title="Perform Gauss-Jordan reduction on m.">gauss_jordan</a>(gj);
        ginv = gj.<a class="code" href="structTooN_1_1Matrix.html#a53b254fb71baceda82834745cef2c60b" title="Extract a sub-matrix.">slice</a>&lt;0,3,3,3&gt;();


        <span class="comment">//Compute the pseudo-inverse with singular value decomposition</span>
        <a class="code" href="classTooN_1_1GR__SVD.html" title="Performs SVD and back substitute to solve equations.">GR_SVD&lt;3,3&gt;</a> bsvd(bad);
        <a class="code" href="structTooN_1_1Matrix.html" title="A matrix.">Matrix&lt;3&gt;</a> sinv = bsvd.get_pinv();


        <a class="code" href="structTooN_1_1Matrix.html" title="A matrix.">Matrix&lt;3&gt;</a> I = <a class="code" href="group__gLinAlg.html#ga738fa6ab6e1ba68370aaa9380fde620c" title="This function is used to add a scalar to the diagonal of a matrix, or to construct matrices...">Identity</a>;
        <a class="code" href="structTooN_1_1Matrix.html" title="A matrix.">Matrix&lt;3&gt;</a> einv = <a class="code" href="group__gEquations.html#gaaa07790d5e8bda259eb708575bc1de8b" title="Return the solution for , given  and .">gaussian_elimination</a>(bad, I);

        <a class="code" href="structTooN_1_1Matrix.html" title="A matrix.">Matrix&lt;3&gt;</a> cinv = invert_cramer(bad);
        
        
        <span class="keywordtype">double</span> lerr = <a class="code" href="group__gLinAlg.html#gaead9da3fd019a6b8db83e10f995374b2" title="Frobenius (root of sum of squares) norm of input matrix m.">norm_fro</a>(linv * bad + -1 * <a class="code" href="group__gLinAlg.html#ga738fa6ab6e1ba68370aaa9380fde620c" title="This function is used to add a scalar to the diagonal of a matrix, or to construct matrices...">Identity</a>);
        <span class="keywordtype">double</span> gerr = <a class="code" href="group__gLinAlg.html#gaead9da3fd019a6b8db83e10f995374b2" title="Frobenius (root of sum of squares) norm of input matrix m.">norm_fro</a>(ginv * bad + -1 * <a class="code" href="group__gLinAlg.html#ga738fa6ab6e1ba68370aaa9380fde620c" title="This function is used to add a scalar to the diagonal of a matrix, or to construct matrices...">Identity</a>);
        <span class="keywordtype">double</span> serr = <a class="code" href="group__gLinAlg.html#gaead9da3fd019a6b8db83e10f995374b2" title="Frobenius (root of sum of squares) norm of input matrix m.">norm_fro</a>(sinv * bad + -1 * <a class="code" href="group__gLinAlg.html#ga738fa6ab6e1ba68370aaa9380fde620c" title="This function is used to add a scalar to the diagonal of a matrix, or to construct matrices...">Identity</a>);
        <span class="keywordtype">double</span> cerr = <a class="code" href="group__gLinAlg.html#gaead9da3fd019a6b8db83e10f995374b2" title="Frobenius (root of sum of squares) norm of input matrix m.">norm_fro</a>(cinv * bad + -1 * <a class="code" href="group__gLinAlg.html#ga738fa6ab6e1ba68370aaa9380fde620c" title="This function is used to add a scalar to the diagonal of a matrix, or to construct matrices...">Identity</a>);
        <span class="keywordtype">double</span> eerr = <a class="code" href="group__gLinAlg.html#gaead9da3fd019a6b8db83e10f995374b2" title="Frobenius (root of sum of squares) norm of input matrix m.">norm_fro</a>(einv * bad + -1 * <a class="code" href="group__gLinAlg.html#ga738fa6ab6e1ba68370aaa9380fde620c" title="This function is used to add a scalar to the diagonal of a matrix, or to construct matrices...">Identity</a>);

        cout &lt;&lt; setprecision(15) &lt;&lt; scientific &lt;&lt; delta &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; lerr &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; gerr &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; serr &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; eerr &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; cerr &lt;&lt; endl;



    }


}
</pre></div><p>The direct inverse with Cramer's rule is about three times faster than the builtin routines. However, the numerical stability is considerably worse, giving errors 1e6 times higher in extreme cases:</p>
<div class="image">
<img src="cramer.png" alt="cramer.png"/>
<div class="caption">
Comparison of errors in matrix inverse</div></div>
</div></div>
<hr class="footer"/><address class="footer"><small>Generated on Wed Feb 8 2012 21:51:59 for TooN by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.4 </small></address>
</body>
</html>
